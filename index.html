<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <title>HTML5 Pacman</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Permanent+Marker" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="shim">shim for font face</div>
    <h1>HTML5 Pacman</h1>
    <p id="instructions">
      <a href="https://github.com/qtech-internal/pacman" target="_blank"
        >Credits: https://github.com/qtech-internal/pacman</a>
    </p>

    <!-- Game Wrapper -->
    <div class="game-wrapper">
      <div id="pacman" aria-label="Pacman Canvas Wrapper"></div>
    </div>

    <!-- Mobile Controls -->
    <div class="controls" aria-label="Mobile Controls">
      <div class="controls-row">
        <button class="ctrl-btn btn-up" data-key="38" aria-label="Up">▲</button>
      </div>
      <div class="controls-row">
        <button class="ctrl-btn btn-left" data-key="37" aria-label="Left">◀</button>
        <button class="ctrl-btn btn-start" data-key="78" aria-label="Start (N)">N</button>
        <button class="ctrl-btn btn-right" data-key="39" aria-label="Right">▶</button>
      </div>
      <div class="controls-row">
        <button class="ctrl-btn btn-down" data-key="40" aria-label="Down">▼</button>
      </div>
      <div class="controls-row small">
        <button class="pill-btn" data-key="80" aria-label="Pause/Resume (P)">Pause</button>
        <button class="pill-btn" data-key="83" aria-label="Toggle Sound (S)">Sound</button>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js" type="text/javascript"></script>
    <script src="./app.js" type="text/javascript"></script>

    <!-- Touch/Click Controls Script -->
    <script>
      (function() {
        function fireKey(code) {
          try {
            const ev = new KeyboardEvent('keydown', {bubbles: true, cancelable: true, keyCode: code, which: code});
            Object.defineProperty(ev, 'keyCode', {get: function(){return code;}});
            Object.defineProperty(ev, 'which', {get: function(){return code;}});
            document.dispatchEvent(ev);
          } catch (e) {
            // Fallback for older browsers
            const ev = document.createEvent('Event');
            ev.initEvent('keydown', true, true);
            ev.keyCode = code;
            ev.which = code;
            document.dispatchEvent(ev);
          }
        }

        // handle tap & press-and-hold to repeat
        let repeatTimer = null;
        const REPEAT_MS = 140;

        function startRepeat(code) {
          fireKey(code);
          clearInterval(repeatTimer);
          repeatTimer = setInterval(function(){ fireKey(code); }, REPEAT_MS);
        }
        function stopRepeat() {
          clearInterval(repeatTimer);
          repeatTimer = null;
        }

        function bindBtn(btn) {
          const code = parseInt(btn.getAttribute('data-key'), 10);
          // Mouse
          btn.addEventListener('mousedown', function(){ startRepeat(code); });
          btn.addEventListener('mouseup', stopRepeat);
          btn.addEventListener('mouseleave', stopRepeat);
          btn.addEventListener('click', function(e){ e.preventDefault(); });
          // Touch
          btn.addEventListener('touchstart', function(e){ e.preventDefault(); startRepeat(code); }, {passive:false});
          btn.addEventListener('touchend', function(e){ e.preventDefault(); stopRepeat(); }, {passive:false});
          btn.addEventListener('touchcancel', stopRepeat, {passive:true});
        }

        document.addEventListener('DOMContentLoaded', function(){
          document.querySelectorAll('.ctrl-btn, .pill-btn').forEach(bindBtn);
        });
      })();
    </script>
  </body>
</html>
