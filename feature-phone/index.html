<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#000000" />
    <title>Pacman - JioPhone</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Splash Screen -->
    <div id="splash-screen">
      <div class="splash-content">
        <div class="pacman-loader">
          <div class="pacman-mouth"></div>
        </div>
        <h2 class="splash-title">PACMAN</h2>
        <div class="loading-dots">
          <span>.</span><span>.</span><span>.</span>
        </div>
        <p class="splash-text">Loading Game...</p>
      </div>
    </div>

    <h1>Pacman</h1>
    <p id="instructions">
      D-PAD: Move | 5/OK: Start | P: Pause
    </p>

    <!-- Game Wrapper -->
    <div class="game-wrapper">
      <div id="pacman" aria-label="Pacman Game"></div>
    </div>

    <!-- Key Guide for Feature Phones -->
    <div class="key-guide">
      <div class="key-row">
        <span class="key">2-UP</span>
        <span class="key">8-DOWN</span>
        <span class="key">4-LEFT</span>
        <span class="key">6-RIGHT</span>
        <span class="key">5-START</span>
      </div>
    </div>

    <!-- JioGames SDK (Load First) -->
    <script src="./jiogames_sdk.js" type="text/javascript"></script>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js" type="text/javascript"></script>
    
    <!-- Game Logic -->
    <script src="./app.js" type="text/javascript"></script>

    <!-- Feature Phone Controls Script (KaiOS/JioPhone) -->
    <script>
      console.log("=== Initializing Feature Phone Controls ===");
      
      (function() {
        // Map numpad keys to arrow keys for feature phones
        var keyMapping = {
          50: 38,  // 2 -> UP
          56: 40,  // 8 -> DOWN
          52: 37,  // 4 -> LEFT
          54: 39,  // 6 -> RIGHT
          53: 78,  // 5 -> N (Start)
          106: 83  // * -> S (Sound)
        };

        // Also handle KaiOS/JioPhone specific keycodes
        var kaiosMapping = {
          'ArrowUp': 38,
          'ArrowDown': 40,
          'ArrowLeft': 37,
          'ArrowRight': 39,
          'Enter': 78,  // Center softkey = Start
          'SoftLeft': 83, // Left softkey = Sound
          '*': 83
        };

        console.log("Key mappings configured:", keyMapping);
        console.log("KaiOS mappings configured:", kaiosMapping);

        function handleKeyPress(e) {
          var keyCode = e.keyCode || e.which;
          var key = e.key;
          
          console.log("Key pressed - Code:", keyCode, "Key:", key);

          // Handle numeric keypad
          if (keyMapping[keyCode]) {
            var mappedCode = keyMapping[keyCode];
            console.log("Mapping key", keyCode, "to", mappedCode);
            fireKey(mappedCode);
            e.preventDefault();
            return false;
          }

          // Handle KaiOS keys
          if (kaiosMapping[key]) {
            console.log("KaiOS key detected:", key);
            fireKey(kaiosMapping[key]);
            e.preventDefault();
            return false;
          }
        }

        function fireKey(code) {
          console.log("Firing keyboard event with code:", code);
          try {
            var ev = new KeyboardEvent('keydown', {
              bubbles: true, 
              cancelable: true, 
              keyCode: code, 
              which: code
            });
            document.dispatchEvent(ev);
            console.log("Event dispatched successfully");
          } catch (e) {
            console.log("Using fallback event method");
            // Fallback for older feature phones
            var ev = document.createEvent('Event');
            ev.initEvent('keydown', true, true);
            ev.keyCode = code;
            ev.which = code;
            document.dispatchEvent(ev);
          }
        }

        // Listen for all key events
        document.addEventListener('keydown', handleKeyPress, true);
        document.addEventListener('keypress', handleKeyPress, true);
        console.log("Event listeners attached");

        // Prevent default scrolling on arrow keys
        window.addEventListener('keydown', function(e) {
          if([37, 38, 39, 40].indexOf(e.keyCode) > -1) {
            e.preventDefault();
            console.log("Prevented default scroll for arrow key");
          }
        }, false);
        
        console.log("=== Feature Phone Controls Initialized ===");
      })();
    </script>
    
    <!-- JioGames Integration Test -->
    <script>
      console.log("=== Testing JioGames Integration ===");
      
      // Test SDK availability
      setTimeout(function() {
        console.log("Testing SDK functions availability:");
        console.log("- cacheAd:", typeof cacheAd);
        console.log("- showAd:", typeof showAd);
        console.log("- postScore:", typeof postScore);
        console.log("- getUserProfile:", typeof getUserProfile);
        
        // Log game initialization
        console.log("Game starting in feature phone mode");
        console.log("Package:", packageName);
      }, 1000);
    </script>

    <!-- Splash Screen Controller -->
    <script>
      (function() {
        console.log("=== Splash Screen: Initializing ===");
        
        var splashScreen = document.getElementById('splash-screen');
        var minDisplayTime = 2000; // Minimum 2 seconds
        var startTime = Date.now();
        
        // Hide splash when everything is loaded
        function hideSplash() {
          var elapsedTime = Date.now() - startTime;
          var remainingTime = Math.max(0, minDisplayTime - elapsedTime);
          
          console.log("Splash Screen: Elapsed time:", elapsedTime + "ms");
          console.log("Splash Screen: Remaining time:", remainingTime + "ms");
          
          setTimeout(function() {
            console.log("=== Splash Screen: Hiding ===");
            splashScreen.style.opacity = '0';
            
            setTimeout(function() {
              splashScreen.style.display = 'none';
              console.log("=== Splash Screen: Hidden ===");
            }, 500); // Fade out duration
          }, remainingTime);
        }
        
        // Hide splash after game initialization
        window.addEventListener('load', function() {
          console.log("Splash Screen: Window loaded");
          // Wait for game to initialize
          setTimeout(hideSplash, 500);
        });
        
        // Fallback: hide after max 5 seconds
        setTimeout(function() {
          console.log("Splash Screen: Fallback timeout - hiding");
          hideSplash();
        }, 5000);
        
      })();
    </script>
  </body>
</html>

